FROM php:7.3-apache-stretch as typo3builder
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    unzip less vim wget git \
# Configure PHP
    libxml2-dev \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libmcrypt-dev \
    libpng-dev \
    libzip-dev \
    zlib1g-dev \ 
    libxslt-dev \
# Install required 3rd party tools
    graphicsmagick && \
# Configure extensions
    docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ && \
    docker-php-ext-install -j$(nproc) mysqli soap gd zip opcache intl xsl && \
    echo 'always_populate_raw_post_data = -1' &&  > /usr/local/etc/php/conf.d/typo3.ini \
    echo 'max_execution_time = 240' >> /usr/local/etc/php/conf.d/typo3.ini && \
    echo 'max_input_vars = 1500' >> /usr/local/etc/php/conf.d/typo3.ini && \
    echo 'upload_max_filesize = 32M' >> /usr/local/etc/php/conf.d/typo3.ini && \
    echo 'post_max_size = 32M' >> /usr/local/etc/php/conf.d/typo3.ini && \
    echo 'xdebug.max_nesting_level = 400' >> /usr/local/etc/php/conf.d/typo3.ini && \
# Install XDebug
    pecl install xdebug && \
    echo "zend_extension=$(find /usr/local/lib/php/extensions/ -name xdebug.so)" > /usr/local/etc/php/conf.d/xdebug.ini && \
# Configure Apache as needed
    a2enmod rewrite && \
# Remove build libraries
    apt-get clean && \
    apt-get -y purge \
        libxml2-dev \
        libfreetype6-dev \
        libjpeg62-turbo-dev \
        libmcrypt-dev \
        libpng-dev \
        libzip-dev \
        zlib1g-dev && \
    rm -rf /var/lib/apt/lists/* /usr/src/*
WORKDIR /var/www/html
COPY --from=composer /usr/bin/composer /usr/bin/composer
RUN echo '{"require":{"typo3/cms":"~8.7.0"}}' > /var/www/html/composer.json && \
    composer update && \
    composer config extra.typo3/cms.cms-package-dir '{$vendor-dir}/typo3/cms' && \
    mkdir typo3temp && \
    mkdir typo3conf && \
    mkdir fileadmin && \
    mkdir uploads && \
    touch FIRST_INSTALL && \
    chown -R www-data .

FROM typo3builder
WORKDIR /var/www/html
RUN composer config repositories.kitodo-publication '{"type": "path", "url": "/app", "options": {"symlink": true}}' && \
    composer config minimum-stability dev && \
    composer config prefer-stable true
RUN composer require devlog/devlog:~3.0.4 && \
    composer require kitodo/presentation
COPY . /app
RUN composer require nimut/testing-framework && \
    composer require kitodo/publication:@dev && \
    chown -R www-data .
